<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Pi Camera WebRTC</title>
</head>

<body>
  <h1>Pi Camera Stream</h1>
  <video id="video" autoplay playsinline muted style="width:640px; height:480px;"></video>

  <script>
    const video = document.getElementById("video");

    // Use WSS if served via HTTPS
    const wsScheme = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsScheme}://${location.hostname}/ws`);

    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    // Receive remote video track
    pc.ontrack = (event) => {
      video.srcObject = event.streams[0];
      console.log("Remote track received");
    };

    // Log connection and ICE states
    pc.onconnectionstatechange = () => console.log("PeerConnection state:", pc.connectionState);
    pc.oniceconnectionstatechange = () => console.log("ICE connection state:", pc.iceConnectionState);

    // Send local ICE candidates to server
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({ candidate: event.candidate }));
        console.log("Sent ICE candidate:", event.candidate);
      }
    };

    // When WebSocket opens, create an offer to receive video
    ws.onopen = async () => {
      try {
        const offer = await pc.createOffer({ offerToReceiveVideo: true });
        await pc.setLocalDescription(offer);

        // Wait for ICE gathering to complete before sending SDP
        if (pc.iceGatheringState === "complete") {
          ws.send(JSON.stringify({ sdp: pc.localDescription }));
        } else {
          pc.onicegatheringstatechange = () => {
            if (pc.iceGatheringState === "complete") {
              ws.send(JSON.stringify({ sdp: pc.localDescription }));
            }
          };
        }
      } catch (err) {
        console.error("Error creating offer:", err);
      }
    };

    // Handle SDP answer and remote ICE candidates from server
    ws.onmessage = async (msg) => {
      const data = JSON.parse(msg.data);
      if (data.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        console.log("Remote description set:", data.sdp.type);
      } else if (data.candidate) {
        try {
          await pc.addIceCandidate(data.candidate);
          console.log("Added remote ICE candidate:", data.candidate);
        } catch (err) {
          console.warn("ICE candidate error:", err);
        }
      }
    };

    ws.onclose = () => console.log("WebSocket closed");
    ws.onerror = (err) => console.error("WebSocket error:", err);
  </script>
</body>

</html>