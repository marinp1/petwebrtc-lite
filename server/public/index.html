<!DOCTYPE html>
<html>
<body>
<video id="video" autoplay playsinline controls></video>
<div id="status">Connecting...</div>
<script>
async function start() {
  const pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  // Add a video transceiver to trigger ICE gathering and SDP media section
  pc.addTransceiver("video", { direction: "recvonly" });

  // Log all ICE candidates
  pc.onicecandidate = (event) => {
    console.log("ICE candidate:", event.candidate);
  };

  // Show the remote video stream
  pc.ontrack = (event) => {
    console.log("Received remote track", event);
    if (event.streams && event.streams[0]) {
      document.getElementById("video").srcObject = event.streams[0];
      console.log("Set video srcObject", event.streams[0]);
    } else {
      console.warn("No streams in ontrack event", event);
    }
    document.getElementById("status").textContent = "Connected!";
  };

  // Monitor connection state
  pc.onconnectionstatechange = () => {
    console.log("Connection state:", pc.connectionState);
    document.getElementById("status").textContent = `Connection: ${pc.connectionState}`;
  };

  pc.oniceconnectionstatechange = () => {
    console.log("ICE connection state:", pc.iceConnectionState);
  };

  // Log SDP offer
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);

  // Wait for ICE gathering to complete before sending offer (with timeout)
  await Promise.race([
    new Promise(resolve => {
      if (pc.iceGatheringState === "complete") {
        resolve();
      } else {
        pc.addEventListener("icegatheringstatechange", function onStateChange() {
          if (pc.iceGatheringState === "complete") {
            pc.removeEventListener("icegatheringstatechange", onStateChange);
            resolve();
          }
        });
      }
    }),
    new Promise(resolve => setTimeout(resolve, 2000)) // 2 second timeout
  ]);

  // IMPORTANT: Use pc.localDescription here, after ICE gathering
  console.log("Offer SDP (ICE complete):\n", pc.localDescription.sdp);

  // Send offer to server
  console.log("Sending offer to server");
  const res = await fetch("/offer", {
    method: "POST",
    body: JSON.stringify(pc.localDescription), // use latest localDescription here
    headers: { "Content-Type": "application/json" },
  });

  if (!res.ok) {
    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
  }

  const answer = await res.json();
  console.log("Received answer from server:", answer);
  console.log("Answer SDP:\n", answer.sdp);
  await pc.setRemoteDescription(answer);
  console.log("Set remote description");
}

start().catch(err => {
  console.error("Error:", err);
  document.getElementById("status").textContent = `Error: ${err.message}`;
});
</script>
</body>
</html>